<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>🍱今天要吃哪一家🍱</title>
<style>
body{
  font-family: 'Noto Sans TC',sans-serif;
  background:#faf3e0;
  text-align:center;
  padding:20px;
}
h1{color:#ff7043;margin-bottom:8px;}
#current{
  display:inline-block;
  min-width:300px;
  max-width:90%;
  width:500px;
  padding:20px 40px;
  margin:40px auto;
  border-radius:16px;
  background:#ffe0b2;
  transition:background 0.2s;
  text-align:center;
  font-size:clamp(2rem, 5vw, 4rem);
  font-weight:bold;
}
#onlineBox{
  position: fixed;
  top: 100px;
  right: 20px;
  width: 180px;
  background: rgba(255,255,255,0.95);
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  font-size: 0.9rem;
  text-align: left;
  z-index: 999;
}
#onlineBox h3{
  margin-top: 0;
  font-size: 1rem;
  color: #ff7043;
  text-align: center;
}
button{
  background:#ff7043;color:#fff;border:0;
  padding:12px 24px;margin:6px;border-radius:10px;
  font-size:clamp(1rem, 2.5vw, 1.4rem);
  cursor:pointer;
}
#history{
  margin-top:30px;
  text-align:left;
  max-width:600px;
  margin-left:auto;margin-right:auto;
}
.history-item{padding:6px 0;border-bottom:1px solid #ddd;}
#login{margin-bottom:20px;}
@media (max-width: 768px){
  #onlineBox{
    position: static;
    width: 90%;
    margin: 20px auto;
    font-size: 1rem;
  }
}
</style>
</head>
<body>

<h1>🍱今天要吃哪一家🍱</h1>

<div id="login">
  <input id="empId" placeholder="輸入工號(6碼數字)" />
  <input id="roomInput" placeholder="房間ID (需在指定名單內)" />
  <button id="joinBtn">加入房間</button>
</div>

<div id="game" style="display:none;">
  <h2>房間：<span id="roomDisplay"></span></h2>
  <div id="current">等待開始…</div>
  <button id="startBtn">開始</button>
  <button id="stopBtn" disabled>停止</button>
  <div id="history"></div>
</div>

<div id="onlineBox">
  <h3>在線人員</h3>
  <div id="userList"></div>
</div>

<audio id="sound" src="tense.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* ---------- Firebase 設定 ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyB0ZBdT2Pq1tawP-L260DRyItt444jg8LI",
  authDomain: "bantogame.firebaseapp.com",
  databaseURL: "https://bantogame-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "bantogame",
  storageBucket: "bantogame.appspot.com",
  messagingSenderId: "411863749354",
  appId: "1:411863749354:web:73df31d40af2a37e5dfd93",
  measurementId: "G-MQ9FFFQ7V9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- 白名單 ---------- */
const validEmpIds = ["091001","086004","091008","095006","100013","100028","106005","110001","110103","111007","111050",
  "111080","112003","113025","113032","114022","110063","111018","094010","C00079","111053","114019"];       // 允許的工號
const allowedRooms = ["CTC"];    // 允許的房間名稱

/* ---------- 餐廳清單 ---------- */
const allRestaurants = [...new Set(`
  老周燒肉飯,福園餡餅粥,冠宏涼麵,今年貴羹,朱麵屋,譚老爺北平麵食,中庄麵館,老闆不夠辣,蘑菇咖哩,
快樂牛排,之澤食堂,赤山肉圓,黃記海南雞飯,悟饕便當,華新牛排,阿爸的飯,阿德飯店,嘉昌火雞肉飯,
今日鴻,曉食記,香檳之城,萬客臨,郭記土魠魚羹,勁請享用,柒零年代,巷尾肉圓
`.split(','))];

/* ---------- DOM ---------- */
const el = {
  empId: document.getElementById('empId'),
  joinBtn: document.getElementById('joinBtn'),
  roomInput: document.getElementById('roomInput'),
  login: document.getElementById('login'),
  userList: document.getElementById('userList'),
  game: document.getElementById('game'),
  roomDisplay: document.getElementById('roomDisplay'),
  current: document.getElementById('current'),
  startBtn: document.getElementById('startBtn'),
  stopBtn: document.getElementById('stopBtn'),
  history: document.getElementById('history'),
  sound: document.getElementById('sound')
};

let roomId, userId, empId;
let interval = null;

/* ---------- 進房 ---------- */
el.joinBtn.onclick = () => {
  empId = el.empId.value.trim();
  if(!/^\d{6}$/.test(empId)){
    alert("工號必須是 6 位數字");
    return;
  }
  if(!validEmpIds.includes(empId)){
    alert("此工號不在允許名單內");
    return;
  }

  const inputRoom = el.roomInput.value.trim();
  if(!allowedRooms.includes(inputRoom)){
    alert("房間名稱必須為指定名單");
    return;
  }
  roomId = inputRoom;
  userId = "u_" + Math.random().toString(36).slice(2,9);

  el.login.style.display="none";
  el.game.style.display="block";
  el.roomDisplay.textContent = roomId;

  const pres = db.ref(`rooms/${roomId}/users/${userId}`);
  pres.set({empId});
  pres.onDisconnect().remove();
  listenRoom();
};

/* ---------- 監聽房間狀態 ---------- */
function listenRoom(){
  const roomRef = db.ref(`rooms/${roomId}`);
  roomRef.on('value', snap=>{
    const data = snap.val()||{};
    if (!data.remaining) {
      roomRef.update({ remaining: allRestaurants, playing: false, playSound:false });
      return;
    }
    renderHistory(data.history||[]);
    if(data.playing === true){
      startAnimation(data.remaining);
    } else {
      stopAnimation(data.current);
    }
  });

  // 監聽音效同步
  db.ref(`rooms/${roomId}/playSound`).on('value', s=>{
    if(s.val() === true){
      el.sound.currentTime=0;
      el.sound.play();
      // 播放後立即重設，避免重複觸發
      db.ref(`rooms/${roomId}/playSound`).set(false);
    }
  });

  // 在線人員
  db.ref(`rooms/${roomId}/users`).on('value', snap=>{
    const users = snap.val() || {};
    const list = Object.values(users).map(u => u.empId);
    el.userList.innerHTML = list.length ? list.join("<br>") : "<em>無人</em>";
  });
}

/* ---------- 開始/停止 ---------- */
el.startBtn.onclick = async ()=>{
  const rSnap = await db.ref(`rooms/${roomId}/remaining`).once('value');
  const remain = rSnap.val()||[];
  if(remain.length===0){
    await db.ref(`rooms/${roomId}`).update({remaining: allRestaurants, history: []});
    return;
  }
  // 觸發所有人播放音效
  db.ref(`rooms/${roomId}`).update({playing:true, playSound:true});
};

el.stopBtn.onclick = async ()=>{
  const rSnap = await db.ref(`rooms/${roomId}/remaining`).once('value');
  const remain = rSnap.val()||[];
  if(remain.length===0)return;
  const pick = remain[Math.floor(Math.random()*remain.length)];
  const newRemain = remain.filter(r=>r!==pick);
  const history = (await db.ref(`rooms/${roomId}/history`).once('value')).val()||[];
  history.push({name:pick,time:Date.now()});
  await db.ref(`rooms/${roomId}`).update({
    playing:false,
    current:pick,
    remaining:newRemain,
    history
  });
};

/* ---------- 動畫 ---------- */
function startAnimation(pool){
  el.startBtn.disabled = true;
  el.stopBtn.disabled = false;
  if(interval) return;
  interval = setInterval(()=>{
    const name = pool[Math.floor(Math.random()*pool.length)];
    el.current.textContent = name;
    el.current.style.background = randomColor();
  },120);
}
function stopAnimation(finalName){
  el.startBtn.disabled = false;
  el.stopBtn.disabled = true;
  if(interval){ clearInterval(interval); interval=null; }
  if(finalName){
    el.current.textContent = "🎉 " + finalName + " 🎉";
    el.current.style.background = "#c8e6c9";
  }
}
function randomColor(){
  const colors=["#ffe0b2","#c8e6c9","#bbdefb","#ffcdd2","#d1c4e9"];
  return colors[Math.floor(Math.random()*colors.length)];
}
function renderHistory(list){
  el.history.innerHTML = "<h3>歷史抽選</h3>" + list.map(
    i=>`<div class="history-item">${new Date(i.time).toLocaleTimeString()}：${i.name}</div>`
  ).join('');
}
</script>
</body>
</html>

