<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä»Šå¤©è¦åƒå“ªä¸€å®¶</title>
<style>
body{
  font-family: 'Noto Sans TC',sans-serif;
  background:#faf3e0;
  text-align:center;
  padding:20px;
}
h1{color:#ff7043;margin-bottom:8px;}
#current{
  font-size:2.2rem;
  margin:40px auto;
  width:80%;
  padding:20px;
  border-radius:16px;
  background:#ffe0b2;
  transition:background 0.2s;
}
button{
  background:#ff7043;color:#fff;border:0;
  padding:12px 24px;margin:6px;border-radius:10px;
  font-size:1.2rem;cursor:pointer;
}
#history{
  margin-top:30px;
  text-align:left;
  max-width:600px;
  margin-left:auto;margin-right:auto;
}
.history-item{padding:6px 0;border-bottom:1px solid #ddd;}
#login{margin-bottom:20px;}
</style>
</head>
<body>

<h1>ä»Šå¤©è¦åƒå“ªä¸€å®¶</h1>

<div id="login">
  <input id="empId" placeholder="è¼¸å…¥å·¥è™Ÿ" />
  <button id="joinBtn">åŠ å…¥æˆ¿é–“</button>
  <input id="roomInput" placeholder="æˆ¿é–“ID (å¯è‡ªè¨‚æˆ–ç•™ç©º)" />
</div>

<div id="game" style="display:none;">
  <h2>æˆ¿é–“ï¼š<span id="roomDisplay"></span></h2>
  <div id="current">ç­‰å¾…é–‹å§‹â€¦</div>
  <button id="startBtn">é–‹å§‹</button>
  <button id="stopBtn" disabled>åœæ­¢</button>
  <div id="history"></div>
</div>

<audio id="sound" src="tense.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* ---------- 1. Firebase è¨­å®šï¼šè«‹æ›æˆä½ çš„ ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyB0ZBdT2Pq1tawP-L260DRyItt444jg8LI",
  authDomain: "bantogame.firebaseapp.com",
  projectId: "bantogame",
  storageBucket: "bantogame.firebasestorage.app",
  messagingSenderId: "411863749354",
  appId: "1:411863749354:web:73df31d40af2a37e5dfd93",
  measurementId: "G-MQ9FFFQ7V9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- 2. é¤å»³æ¸…å–® ---------- */
const allRestaurants = [...new Set(`
ç¶è¹„è¹¤å ‚,ä¸€å¤«æ’éª¨,è€å‘¨ç‡’è‚‰é£¯,å¤§å¯®ç‰›è‚‰éºµ,ç¦åœ’é¤¡é¤…ç²¥,æ—å®¶æ¶¼éºµ,èŠ±ã®å£½å¸,å† å®æ¶¼éºµ,å¤æ—©é­,å¤ç³§ç¢³çƒ¤ä¸‰æ˜æ²»,æ±Ÿé³¥ç´…,æ­¦æ‘é¢¨å‘³ä¾¿ç•¶,
å¤§å’–å’–å“©,æ±æ¸¯é£¯æ¹¯,ä¾¿ç•¶çˆºçˆº,çœŸå¿ƒé£ŸåŠ,è¶ŠéŒ¦é£Ÿå ‚,ä»Šå¹´è²´ç¾¹,é˜¿æ˜‡å»šæˆ¿,å¤§å»Ÿå£é¹½æ°´é›,é³³æ—å±±è¥¿åˆ€å‰Šéºµ,å…«å…©äº”éª¨é´¨,å¯¶éº—é»å¿ƒå»šæˆ¿,
åŒæ˜Œå¤§é›è…¿,æœ±éºµå±‹,å‘·é£½é£½å‰µæ„é‹ç‡’,æ—å®¶æ°´é¤ƒ,è­šè€çˆºåŒ—å¹³éºµé£Ÿ,å‚»å¸«å‚…æ¹¯é¤ƒ,39 Pizza,ä¸­åº„éºµé¤¨,é´¨é„‰å¯¶,è€é—†ä¸å¤ è¾£,è˜‘è‡å’–å“©,
æ­¦å£«ç‚’é£¯,é™ ç¢—ç³•,å¿«æ¨‚ç‰›æ’,ä¹‹æ¾¤é£Ÿå ‚,ä¸Šé‡ç‡’è‚‰é£¯,èµ¤å±±è‚‰åœ“,é»ƒè¨˜æµ·å—é›é£¯,è€æ±Ÿç´…èŒ¶,æ‚Ÿé¥•ä¾¿ç•¶,ç„¡åä¾¿ç•¶,æ´¥ä¸¼å°é¤¨,ç±³ç¦¾ç‚’é£¯,
è¯æ–°ç‰›æ’,é˜¿çˆ¸çš„é£¯,é˜¿å¾·é£¯åº—,å˜‰æ˜Œç«é›è‚‰é£¯,ä»Šæ—¥é´»,æ›‰é£Ÿè¨˜,é¦™æª³ä¹‹åŸ,è¬å®¢è‡¨,éƒ­è¨˜åœŸé­ é­šç¾¹,å‹è«‹äº«ç”¨,æŸ’é›¶å¹´ä»£
`.split(','))];

/* ---------- 3. DOM åƒç…§ ---------- */
const el = {
  empId: document.getElementById('empId'),
  joinBtn: document.getElementById('joinBtn'),
  roomInput: document.getElementById('roomInput'),
  login: document.getElementById('login'),
  game: document.getElementById('game'),
  roomDisplay: document.getElementById('roomDisplay'),
  current: document.getElementById('current'),
  startBtn: document.getElementById('startBtn'),
  stopBtn: document.getElementById('stopBtn'),
  history: document.getElementById('history'),
  sound: document.getElementById('sound')
};

let roomId, userId, empId;
let interval = null;

/* ---------- 4. é€²æˆ¿ ---------- */
el.joinBtn.onclick = () => {
  empId = el.empId.value.trim();
  if(!empId){alert("è«‹è¼¸å…¥å·¥è™Ÿ");return;}
  roomId = el.roomInput.value.trim() || randomId();
  userId = "u_" + Math.random().toString(36).slice(2,9);
  el.login.style.display="none";
  el.game.style.display="block";
  el.roomDisplay.textContent = roomId;
  // presence
  const pres = db.ref(`rooms/${roomId}/users/${userId}`);
  pres.set({empId});
  pres.onDisconnect().remove();
  listenRoom();
};

function randomId(len=6){
  const c="ABCDEFGHJKMNPQRSTUVWXYZ23456789";let s="";
  for(let i=0;i<len;i++)s+=c[Math.floor(Math.random()*c.length)];
  return s;
}

/* ---------- 5. ç›£è½æˆ¿é–“ç‹€æ…‹ ---------- */
function listenRoom(){
  db.ref(`rooms/${roomId}`).on('value', snap=>{
    const data = snap.val()||{};
    // ç›®å‰å‰©é¤˜æ¸…å–®
    if(!data.remaining){
      db.ref(`rooms/${roomId}/remaining`).set(allRestaurants);
      return;
    }
    // æ›´æ–°æ­·å²
    renderHistory(data.history||[]);
    // è‹¥æœ‰äººæ­£åœ¨è·‘å‹•ç•«
    if(data.playing){
      startAnimation(data.remaining);
    }else{
      stopAnimation(data.current);
    }
  });
}

/* ---------- 6. é–‹å§‹/åœæ­¢ ---------- */
el.startBtn.onclick = async ()=>{
  const rSnap = await db.ref(`rooms/${roomId}/remaining`).once('value');
  const remain = rSnap.val()||[];
  if(remain.length===0){
    await db.ref(`rooms/${roomId}`).update({remaining: allRestaurants, history: []});
    return;
  }
  el.sound.currentTime=0; el.sound.play();
  db.ref(`rooms/${roomId}`).update({playing:true});
};
el.stopBtn.onclick = async ()=>{
  const rSnap = await db.ref(`rooms/${roomId}/remaining`).once('value');
  const remain = rSnap.val()||[];
  if(remain.length===0)return;
  const pick = remain[Math.floor(Math.random()*remain.length)];
  const newRemain = remain.filter(r=>r!==pick);
  const history = (await db.ref(`rooms/${roomId}/history`).once('value')).val()||[];
  history.push({name:pick,time:Date.now()});
  await db.ref(`rooms/${roomId}`).update({
    playing:false,
    current:pick,
    remaining:newRemain,
    history
  });
};

/* ---------- 7. å‹•ç•«é¡¯ç¤º ---------- */
function startAnimation(pool){
  el.startBtn.disabled = true;
  el.stopBtn.disabled = false;
  if(interval) return;
  interval = setInterval(()=>{
    const name = pool[Math.floor(Math.random()*pool.length)];
    el.current.textContent = name;
    el.current.style.background = randomColor();
  },120);
}
function stopAnimation(finalName){
  el.startBtn.disabled = false;
  el.stopBtn.disabled = true;
  if(interval){ clearInterval(interval); interval=null; }
  if(finalName){
    el.sound.pause();
    el.current.textContent = "ğŸ‰ " + finalName + " ğŸ‰";
    el.current.style.background = "#c8e6c9";
  }
}
function randomColor(){
  const colors=["#ffe0b2","#c8e6c9","#bbdefb","#ffcdd2","#d1c4e9"];
  return colors[Math.floor(Math.random()*colors.length)];
}

/* ---------- 8. æ­·å²é¡¯ç¤º ---------- */
function renderHistory(list){
  el.history.innerHTML = "<h3>æ­·å²æŠ½é¸</h3>" + list.map(
    i=>`<div class="history-item">${new Date(i.time).toLocaleTimeString()}ï¼š${i.name}</div>`
  ).join('');
}
</script>
</body>
</html>
